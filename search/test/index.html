<!doctype html>
<html lang="it">
  <head>
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0">
    <style>
      .hide {
        display: none;
      }
    </style>
    <script>
      document.addEventListener('DOMContentLoaded', _ => {
        fetch('/data/search/groups7.json')
          .then(data => data.json())
          .then(data => {
            const searchData = {};

            data.index_data.forEach(({id, ccs, pianostudi, annocorso}) => {
              if (!searchData[ccs]){
                searchData[ccs] = {};
              }

              if (!searchData[ccs][pianostudi]){
                searchData[ccs][pianostudi] = {
                  'All': {}
                };
              }

              if (!searchData[ccs][pianostudi][annocorso]){
                searchData[ccs][pianostudi][annocorso] = {};
              }

              let tmp = genHtml(data.info_data[id]);
              searchData[ccs][pianostudi][annocorso][id] = tmp;
              searchData[ccs][pianostudi]['All'][id] = tmp;
            });

            _updateDatalist(searchData, 'ccs');

            window.searchData = searchData;

            document.getElementById('content-loading').classList.add('hide');
            document.getElementById('content-form').classList.remove('hide');
          })
          .catch(e => {
            console.error(e);
            alert('Impossibile Caricare la ricerca. Controlla la tua connessione a internet');
          });
      });

      function onCcsClick(){
        document.getElementById(`content-form-ccs-input`).value = '';
        document.getElementById(`content-form-pianostudi-input`).value = '';
        document.getElementById(`content-form-annocorso-input`).value = '';
        document.getElementById('content-result').innerHTML = '';
      }

      function onPianostudiClick(){
        document.getElementById(`content-form-pianostudi-input`).value = '';
        document.getElementById(`content-form-annocorso-input`).value = '';
        document.getElementById('content-result').innerHTML = '';
      }

      function onAnnocorsoClick(){
        document.getElementById(`content-form-annocorso-input`).value = '';
        document.getElementById('content-result').innerHTML = '';
      }

      function onCcsSelect(){
        let ccs = document.getElementById(`content-form-ccs-input`).value;
        let list = _updateDatalist(window.searchData[ccs], 'pianostudi');
        if (list.length > 0){
          document.getElementById(`content-form-pianostudi-input`).value = list[0];
          onPianostudiSelect();
        }
      }

      function onPianostudiSelect(){
        let ccs = document.getElementById(`content-form-ccs-input`).value;
        let pianostudi = document.getElementById(`content-form-pianostudi-input`).value;
        let list = _updateDatalist(window.searchData[ccs][pianostudi], 'annocorso');
        if (list.length > 0){
          document.getElementById(`content-form-annocorso-input`).value = 'All';
          onAnnocorsoSelect()
        }
      }

      function onAnnocorsoSelect(){
        let ccs = document.getElementById(`content-form-ccs-input`).value;
        let pianostudi = document.getElementById(`content-form-pianostudi-input`).value;
        let annocorso = document.getElementById(`content-form-annocorso-input`).value;

        // Ignoring error due to wrong search query. No Problem, user will, eventually, fix the query.
        let tmp = Object.keys(window.searchData[ccs][pianostudi][annocorso])
          .map(k => window.searchData[ccs][pianostudi][annocorso][k])
          .join("");
        document.getElementById('content-result').innerHTML = tmp;
      }

      // function selectHandler(){
      //   let ccs = document.getElementById(`content-form-ccs-input`).value;
      //   let pianostudi = document.getElementById(`content-form-pianostudi-input`).value;
      //   let annocorso = document.getElementById(`content-form-annocorso-input`).value;
      //
      //   // Ignoring error due to wrong search query. No Problem, user will, eventually, fix the query.
      //   _updateDatalist(window.searchData[ccs], 'pianostudi');
      //   _updateDatalist(window.searchData[ccs][pianostudi], 'annocorso');
      //   let tmp = Object.keys(window.searchData[ccs][pianostudi][annocorso])
      //     .map(k => window.searchData[ccs][pianostudi][annocorso][k])
      //     .join("");
      //   document.getElementById('content-result').innerHTML = tmp;
      // }

      function genHtml(data){
        return `<li>${JSON.stringify(data)}</li>`;
      }

      function _updateDatalist(data, id){
        data = data || [];

        let tmp = Object.keys(data)
          .filter(item => item && item !== 'null');

        if (tmp.length === 0){
          return [];
        }

        document.getElementById(`content-form-${id}-datalist`).innerHTML = tmp
          .map(k => `<option value="${k}"></option>`);
        return tmp;
      }
    </script>
    <title>
      ???
    </title>
  </head>
  <body>
    <div id="content">
      <div id="content-loading">
        Loading...
      </div>
      <form id="content-form" class="hide">
        <input type="select" id="content-form-ccs-input" list="content-form-ccs-datalist" name="ccs" onclick="onCcsClick()" onchange="onCcsSelect()" onkeypress="onCcsSelect()" />
        <datalist data-id="ccs" id="content-form-ccs-datalist"></datalist>
        <input type="select" id="content-form-pianostudi-input" list="content-form-pianostudi-datalist" name="pianostudi" onclick="onPianostudiClick()" onchange="onPianostudiSelect()" onkeypress="onPianostudiSelect()" />
        <datalist data-id="pianostudi" id="content-form-pianostudi-datalist"></datalist>
        <input type="select" id="content-form-annocorso-input" list="content-form-annocorso-datalist" name="annocorso" onclick="onAnnocorsoClick()" onchange="onAnnocorsoSelect()" onkeypress="onAnnocorsoSelect()" />
        <datalist data-id="annocorso" id="content-form-annocorso-datalist"></datalist>
      </form>
      <ul id="content-result"></ul>
    </div>
  </body>
</html>